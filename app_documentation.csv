"Section","Sub-Section","Name","Detail 1","Detail 2","Detail 3","Detail 4","Detail 5","Detail 6","Detail 7","Detail 8"
"API ENDPOINTS","auth","/api/auth/login","POST","User Login mit Rate Limiting, hCaptcha, Device Verification, Geolocation","Request: { email, password, tenantId?, rememberMe?, captchaToken? }","Response: { success, user, profile, session: { access_token, refresh_token, expires_in }, rememberMe }","Auth: None (öffentlich, aber Rate Limited)","DB: users, tenants, login_attempts, blocked_ip_addresses, user_devices","Calls: checkRateLimit(), validateEmail(), setAuthCookies(), getIPLocation(), sendEmail(), record_failed_login, reset_failed_login_attempts"
"API ENDPOINTS","appointments","/api/appointments/save","POST","Erstellt oder aktualisiert Appointment, verwaltet Availability Slots, erstellt Payment Records","Request: { mode: 'create'|'edit', eventId?, appointmentData, totalAmountRappenForPayment?, paymentMethodForPayment?, creditUsedRappen?, basePriceRappen?, adminFeeRappen?, productsPriceRappen?, discountAmountRappen?, companyBillingAddressId? }","Response: { success: true, data: appointment }","Auth: Bearer Token (authenticated)","DB: appointments, payments, availability_slots, student_credits","Calls: validateAppointmentData(), createAvailabilitySlotManager(), /api/validate/category, /api/availability/queue-recalc, /api/reminders/send-appointment-confirmation"
"API ENDPOINTS","payments","/api/payments/process","POST","Verarbeitet Zahlungen mit Credit-Deduktion und Wallee-Integration","Request: { paymentId, orderId?, successUrl?, failedUrl? }","Response: { success, paymentId, transactionId?, paymentUrl?, paymentStatus, message }","Auth: Bearer Token (authenticated)","DB: payments, student_credits, credit_transactions, payment_wallee_transactions, appointments","Calls: checkRateLimit(), getWalleeConfigForTenant(), buildMerchantReference(), logAudit(), Wallee SDK"
"API ENDPOINTS","wallee","/api/wallee/webhook","POST","Wallee Webhook Handler für Payment Status Updates","Request: Wallee Webhook Payload { listenerEntityId, listenerEntityTechnicalName, spaceId, id, state, entityId, timestamp }","Response: { success, message, payment_ids?, payments_updated?, new_status?, duration_ms? }","Auth: None (Webhook mit optionaler Signature)","DB: payments, webhook_logs, payment_wallee_transactions, course_registrations, appointments, student_credits, credit_transactions, vouchers, products, product_sales","Calls: fetchWalleeTransaction(), enrollInSARIAfterPayment(), handleCreditRefund(), confirmCreditDeduction(), processVouchersAndCredits(), savePaymentToken(), sendCourseEnrollmentEmails(), updateSessionParticipantCounts()"
"DATABASE QUERIES","SELECT","users","User Lookups (by auth_user_id, email, tenant_id, role)","","","","","",""
"DATABASE QUERIES","SELECT","appointments","Appointment Queries (by staff_id, user_id, tenant_id, date ranges, status)","","","","","",""
"DATABASE QUERIES","SELECT","payments","Payment Queries (by user_id, appointment_id, payment_status, wallee_transaction_id)","","","","","",""
"DATABASE QUERIES","SELECT","availability_slots","Availability Queries (by tenant_id, staff_id, time ranges, is_available)","","","","","",""
"DATABASE QUERIES","SELECT","staff_working_hours","Working Hours (by staff_id, day_of_week)","","","","","",""
"DATABASE QUERIES","SELECT","external_busy_times","External Busy Times (by staff_id, time ranges)","","","","","",""
"DATABASE QUERIES","SELECT","categories","Categories (by tenant_id, is_active, parent_category_id)","","","","","",""
"DATABASE QUERIES","SELECT","event_types","Event Types (by tenant_id, is_active)","","","","","",""
"DATABASE QUERIES","SELECT","locations","Locations (by tenant_id, is_active)","","","","","",""
"DATABASE QUERIES","SELECT","products","Products (by tenant_id, is_active, category)","","","","","",""
"DATABASE QUERIES","SELECT","discounts","Discounts (by tenant_id, is_active, category_code)","","","","","",""
"DATABASE QUERIES","SELECT","student_credits","Student Credits (by user_id, tenant_id)","","","","","",""
"DATABASE QUERIES","SELECT","credit_transactions","Credit Transactions (by user_id, reference_id)","","","","","",""
"DATABASE QUERIES","SELECT","course_registrations","Course Registrations (by course_id, user_id, payment_id, status)","","","","","",""
"DATABASE QUERIES","SELECT","courses","Courses (by tenant_id, sari_managed, sari_course_id)","","","","","",""
"DATABASE QUERIES","SELECT","tenants","Tenants (by id, slug)","","","","","",""
"DATABASE QUERIES","SELECT","tenant_settings","Tenant Settings (by tenant_id)","","","","","",""
"DATABASE QUERIES","SELECT","vouchers","Vouchers (by code, user_id, tenant_id)","","","","","",""
"DATABASE QUERIES","SELECT","invoices","Invoices (by tenant_id, user_id, status)","","","","","",""
"DATABASE QUERIES","SELECT","invoice_items","Invoice Items (by invoice_id)","","","","","",""
"DATABASE QUERIES","SELECT","webhook_logs","Webhook Logs (by transaction_id, payment_id)","","","","","",""
"DATABASE QUERIES","SELECT","payment_wallee_transactions","Payment Wallee Transactions (by payment_id, wallee_transaction_id)","","","","","",""
"DATABASE QUERIES","SELECT","audit_logs","Audit Logs (by user_id, tenant_id, action, resource_type)","","","","","",""
"DATABASE QUERIES","SELECT","login_attempts","Login Attempts (by email, ip_address, user_id)","","","","","",""
"DATABASE QUERIES","SELECT","rate_limit_logs","Rate Limit Logs (by ip_address, operation, email)","","","","","",""
"DATABASE QUERIES","SELECT","booking_proposals","Booking Proposals (by tenant_id, staff_id, status)","","","","","",""
"DATABASE QUERIES","SELECT","booking_reservations","Booking Reservations (by slot_id, session_id)","","","","","",""
"DATABASE QUERIES","SELECT","examiners","Examiners (by tenant_id)","","","","","",""
"DATABASE QUERIES","SELECT","exam_results","Exam Results (by appointment_id, examiner_id, tenant_id)","","","","","",""
"DATABASE QUERIES","SELECT","webauthn_credentials","WebAuthn Credentials (by user_id, credential_id)","","","","","",""
"DATABASE QUERIES","SELECT","user_devices","User Devices (by user_id, mac_address)","","","","","",""
"DATABASE QUERIES","SELECT","staff_locations","Staff Locations (by staff_id, location_id, tenant_id)","","","","","",""
"DATABASE QUERIES","SELECT","outbound_messages_queue","Outbound Messages (by status, tenant_id, send_at)","","","","","",""
"DATABASE QUERIES","SELECT","payment_reminders","Payment Reminders (by payment_id, user_id, status)","","","","","",""
"DATABASE QUERIES","SELECT","availability_recalc_queue","Availability Recalc Queue (by staff_id, tenant_id, processed)","","","","","",""
"DATABASE QUERIES","SELECT","error_logs","Error Logs (by tenant_id, severity)","","","","","",""
"DATABASE QUERIES","SELECT","cron_jobs","Cron Jobs (by name, status)","","","","","",""
"DATABASE QUERIES","INSERT","appointments","Appointment Creation","","","","","",""
"DATABASE QUERIES","INSERT","payments","Payment Creation","","","","","",""
"DATABASE QUERIES","INSERT","users","User Creation","","","","","",""
"DATABASE QUERIES","INSERT","student_credits","Student Credit Creation","","","","","",""
"DATABASE QUERIES","INSERT","credit_transactions","Credit Transaction Logging","","","","","",""
"DATABASE QUERIES","INSERT","course_registrations","Course Registration Creation","","","","","",""
"DATABASE QUERIES","INSERT","invoices","Invoice Creation","","","","","",""
"DATABASE QUERIES","INSERT","invoice_items","Invoice Item Creation","","","","","",""
"DATABASE QUERIES","INSERT","vouchers","Voucher Creation","","","","","",""
"DATABASE QUERIES","INSERT","webhook_logs","Webhook Log Creation","","","","","",""
"DATABASE QUERIES","INSERT","payment_wallee_transactions","Payment Wallee Transaction History","","","","","",""
"DATABASE QUERIES","INSERT","audit_logs","Audit Log Creation","","","","","",""
"DATABASE QUERIES","INSERT","login_attempts","Login Attempt Logging","","","","","",""
"DATABASE QUERIES","INSERT","rate_limit_logs","Rate Limit Logging","","","","","",""
"DATABASE QUERIES","INSERT","booking_proposals","Booking Proposal Creation","","","","","",""
"DATABASE QUERIES","INSERT","booking_reservations","Booking Reservation Creation","","","","","",""
"DATABASE QUERIES","INSERT","webauthn_credentials","WebAuthn Credential Creation","","","","","",""
"DATABASE QUERIES","INSERT","user_devices","User Device Registration","","","","","",""
"DATABASE QUERIES","INSERT","staff_locations","Staff Location Assignment","","","","","",""
"DATABASE QUERIES","INSERT","outbound_messages_queue","Outbound Message Queueing","","","","","",""
"DATABASE QUERIES","INSERT","payment_reminders","Payment Reminder Creation","","","","","",""
"DATABASE QUERIES","INSERT","availability_recalc_queue","Availability Recalc Queueing","","","","","",""
"DATABASE QUERIES","INSERT","error_logs","Error Log Creation","","","","","",""
"DATABASE QUERIES","UPDATE","appointments","Appointment Updates (status, payment_status, times, etc.)","","","","","",""
"DATABASE QUERIES","UPDATE","payments","Payment Updates (payment_status, wallee_transaction_id, credit_used_rappen, etc.)","","","","","",""
"DATABASE QUERIES","UPDATE","users","User Updates (profile, password_strength_version, etc.)","","","","","",""
"DATABASE QUERIES","UPDATE","student_credits","Credit Balance Updates","","","","","",""
"DATABASE QUERIES","UPDATE","availability_slots","Slot Updates (is_available, reserved_until, appointment_id)","","","","","",""
"DATABASE QUERIES","UPDATE","course_registrations","Registration Updates (status, payment_status, sari_synced)","","","","","",""
"DATABASE QUERIES","UPDATE","invoices","Invoice Updates (status, paid_at)","","","","","",""
"DATABASE QUERIES","UPDATE","vouchers","Voucher Updates (redeemed_at, is_active)","","","","","",""
"DATABASE QUERIES","UPDATE","user_devices","Device Updates (last_seen, is_trusted)","","","","","",""
"DATABASE QUERIES","UPDATE","staff_locations","Staff Location Updates (is_online_bookable)","","","","","",""
"DATABASE QUERIES","UPDATE","outbound_messages_queue","Message Status Updates","","","","","",""
"DATABASE QUERIES","UPDATE","payment_reminders","Reminder Status Updates","","","","","",""
"DATABASE QUERIES","UPDATE","availability_recalc_queue","Recalc Queue Status Updates","","","","","",""
"DATABASE QUERIES","DELETE","appointments","Soft Delete (deleted_at setzen)","","","","","",""
"DATABASE QUERIES","DELETE","users","User Deletion (Hard Delete via Migration)","","","","","",""
"DATABASE QUERIES","DELETE","webauthn_credentials","WebAuthn Credential Deletion","","","","","",""
"DATABASE QUERIES","DELETE","booking_reservations","Reservation Release","","","","","",""
"DATABASE QUERIES","RPC Functions","record_failed_login","Failed Login Tracking","","","","","",""
"DATABASE QUERIES","RPC Functions","reset_failed_login_attempts","Reset Login Attempts","","","","","",""
"DATABASE QUERIES","RPC Functions","cleanup_expired_slot_reservations","Cleanup Expired Reservations","","","","","",""
"DATABASE QUERIES","RPC Functions","update_availability_slots_updated_at","Trigger Function","","","","","",""
"COMPOSABLES","Auth","usePayments","Payment Processing Logic mit Cash/Invoice/Wallee Support","Calls: /api/staff/create-payment, /api/payments/update-wallee-id, /api/wallee/create-transaction, /api/appointments/update-payment-status, /api/products/list, useDiscounts()","Called by: Payment Components, Event Modal, Shop","","","",""
"COMPOSABLES","Auth","useCurrentUser","Current User Management mit Auth Store Integration","Calls: /api/auth/current-user, /api/users/create-profile","Called by: Alle Components die User Info brauchen","","","",""
"COMPOSABLES","Auth","useStudents","Student Management mit Filtering und Search","Calls: users Table Query (SELECT), useSmsService()","Called by: Student Management Components","","","",""
"DATABASE TABLES","users","id (UUID, PK), auth_user_id (UUID), email, first_name, last_name, phone, role, tenant_id (FK), is_active, preferred_payment_method, password_strength_version, assigned_staff_id, onboarding_token, onboarding_token_expires, onboarding_status, created_at, updated_at","Primary Key: id","Foreign Keys: tenant_id → tenants(id), assigned_staff_id → users(id)","Unique Constraints: email + tenant_id (unique)","RLS Policies: Tenant-based access, Staff can view own students, Admins can view all","Indexes: auth_user_id, tenant_id, email, role, is_active","","",""
"DATABASE TABLES","appointments","id (UUID, PK), user_id (FK), staff_id (FK), tenant_id (FK), start_time, end_time, duration_minutes, type, event_type_code, title, description, status, payment_status, location_id (FK), custom_location_name, custom_location_address, deleted_at, created_at, updated_at","Primary Key: id","Foreign Keys: user_id → users(id), staff_id → users(id), tenant_id → tenants(id), location_id → locations(id)","RLS Policies: Users can view own appointments, Staff can view tenant appointments, Admins can view all","Indexes: user_id, staff_id, tenant_id, start_time, end_time, status, deleted_at","","",""
"DATABASE TABLES","payments","id (UUID, PK), user_id (FK), staff_id (FK), tenant_id (FK), appointment_id (FK), course_registration_id (FK), lesson_price_rappen, admin_fee_rappen, products_price_rappen, discount_amount_rappen, voucher_discount_rappen, subtotal_rappen, total_amount_rappen, credit_used_rappen, payment_method, payment_status, currency, description, wallee_transaction_id, company_billing_address_id (FK), metadata (JSONB), is_standalone, paid_at, reminder_sent_at, created_at, updated_at","Primary Key: id","Foreign Keys: user_id → users(id), staff_id → users(id), tenant_id → tenants(id), appointment_id → appointments(id), course_registration_id → course_registrations(id), company_billing_address_id → company_billing_addresses(id)","RLS Policies: Users can view own payments, Staff can view tenant payments, Admins can view all","Indexes: user_id, appointment_id, payment_status, wallee_transaction_id, tenant_id, created_at","","",""
"DATABASE TABLES","availability_slots","id (UUID, PK), tenant_id (FK), staff_id (FK), location_id (FK), start_time, end_time, duration_minutes, is_available, booking_type, slot_type, calculated_at, reserved_until, reserved_by_session, appointment_id (FK), is_primary_reservation, created_at, updated_at","Primary Key: id","Foreign Keys: tenant_id → tenants(id), staff_id → users(id), location_id → locations(id), appointment_id → appointments(id)","RLS Policies: Public can view available slots, Staff can view all tenant slots, Anonymous can update for reservations","Indexes: tenant_id + staff_id + is_available + start_time + end_time, staff_id + start_time, appointment_id, reserved_until","","",""
"DATABASE TABLES","student_credits","id (UUID, PK), user_id (FK), tenant_id (FK), balance_rappen, created_at, updated_at","Primary Key: id","Foreign Keys: user_id → users(id), tenant_id → tenants(id)","RLS Policies: Users can view own credits, Staff can view tenant credits","Indexes: user_id, tenant_id","","",""
"DATABASE TABLES","credit_transactions","id (UUID, PK), user_id (FK), tenant_id (FK), transaction_type, amount_rappen, balance_before_rappen, balance_after_rappen, payment_method, reference_id, reference_type, notes, status, created_at","Primary Key: id","Foreign Keys: user_id → users(id), tenant_id → tenants(id)","RLS Policies: Users can view own transactions","Indexes: user_id, reference_id, created_at","","",""
"DATABASE TABLES","course_registrations","id (UUID, PK), course_id (FK), tenant_id (FK), user_id (FK), payment_id (FK), first_name, last_name, email, phone, sari_faberid, status, payment_status, custom_sessions (JSONB), sari_synced, sari_synced_at, webhook_processed_at, created_at, updated_at, expires_at","Primary Key: id","Foreign Keys: course_id → courses(id), tenant_id → tenants(id), user_id → users(id), payment_id → payments(id)","RLS Policies: Users can view own registrations, Staff can view tenant registrations","Indexes: course_id, user_id, payment_id, status, expires_at","","",""
"DATABASE TABLES","tenants","id (UUID, PK), name, slug, business_type, primary_color, secondary_color, accent_color, logo_url, logo_square_url, logo_wide_url, is_active, created_at, updated_at","Primary Key: id","Unique Constraints: slug (unique)","RLS Policies: Public can view active tenants, Authenticated can view own tenant","Indexes: slug, is_active","","",""
"DATABASE TABLES","webhook_logs","id (UUID, PK), transaction_id, entity_id, space_id, wallee_state, listener_entity_id, listener_entity_technical_name, timestamp, payment_id (FK), payment_status_before, payment_status_after, success, error_message, processing_duration_ms, raw_payload (JSONB), created_at","Primary Key: id","Foreign Keys: payment_id → payments(id)","RLS Policies: Service role only (no public access)","Indexes: transaction_id, payment_id, created_at","","",""
"DATABASE TABLES","audit_logs","id (UUID, PK), user_id (FK), auth_user_id, action, resource_type, resource_id, status, error_message, details (JSONB), ip_address, user_agent, tenant_id (FK), created_at, updated_at","Primary Key: id","Foreign Keys: user_id → users(id), tenant_id → tenants(id)","RLS Policies: Users can view own logs, Admins can view tenant logs, Super admins can view all","Indexes: user_id, action, resource_type, tenant_id, status, created_at","","",""
"DATABASE TABLES","categories","id (INT, PK), name, description, code, color, is_active, exam_duration_minutes, lesson_duration_minutes, theory_durations, tenant_id (FK), document_requirements (JSONB), parent_category_id (FK), icon_svg, created_at, updated_at","Primary Key: id","Foreign Keys: tenant_id → tenants(id), parent_category_id → categories(id)","RLS Policies: Tenant-based access, Public can view active categories","Indexes: code, tenant_id, is_active","","",""
"DATABASE TABLES","event_types","id (INT, PK), name, code, is_active, default_duration_minutes, tenant_id (FK), created_at, updated_at","Primary Key: id","Foreign Keys: tenant_id → tenants(id)","RLS Policies: Tenant-based access, Public can view active event types","Indexes: code, tenant_id, is_active","","",""
"DATABASE TABLES","locations","id (UUID, PK), name, address, latitude, longitude, google_place_id, formatted_address, location_type, user_id (FK), is_active, tenant_id (FK), category, available_categories (TEXT[]), pickup_enabled, pickup_radius_minutes, category_pickup_settings (JSONB), time_windows (JSONB), canton, city, postal_code, created_at, updated_at, staff_ids (UUID[]), public_bookable","Primary Key: id","Foreign Keys: user_id → users(id), tenant_id → tenants(id)","RLS Policies: Tenant-based access, Public can view active locations","Indexes: tenant_id, is_active, location_type, staff_ids, postal_code","","",""
"DATABASE TABLES","products","id (UUID, PK), name, description, price_rappen, is_active, category, tenant_id (FK), created_at, updated_at","Primary Key: id","Foreign Keys: tenant_id → tenants(id)","RLS Policies: Tenant-based access, Public can view active products","Indexes: tenant_id, is_active, category","","",""
"DATABASE TABLES","discounts","id (UUID, PK), name, description, code, discount_percentage, fixed_amount_rappen, min_price_rappen, max_redemptions, is_active, category_code, tenant_id (FK), created_at, updated_at","Primary Key: id","Foreign Keys: tenant_id → tenants(id)","RLS Policies: Tenant-based access, Public can view active discounts","Indexes: tenant_id, is_active, code, category_code","","",""
"DATABASE TABLES","vouchers","id (UUID, PK), code, type, value_rappen, is_active, expires_at, created_at, updated_at, tenant_id (FK)","Primary Key: id","Foreign Keys: tenant_id → tenants(id)","RLS Policies: Tenant-based access, Public can redeem active vouchers","Indexes: tenant_id, code, is_active","","",""
"DATABASE TABLES","invoices","id (UUID, PK), invoice_number, user_id (FK), tenant_id (FK), due_date, total_amount_rappen, status, paid_at, created_at, updated_at","Primary Key: id","Foreign Keys: user_id → users(id), tenant_id → tenants(id)","RLS Policies: Tenant-based access, Users can view own invoices, Staff can view tenant invoices","Indexes: tenant_id, user_id, status, due_date","","",""
"DATABASE TABLES","invoice_items","id (UUID, PK), invoice_id (FK), description, quantity, unit_price_rappen, total_rappen, created_at, updated_at","Primary Key: id","Foreign Keys: invoice_id → invoices(id)","RLS Policies: Tenant-based access (via invoices)","Indexes: invoice_id","","",""
"DATABASE TABLES","staff_working_hours","id (UUID, PK), staff_id (FK), day_of_week, start_time (TIME), end_time (TIME), is_active, tenant_id (FK), created_at, updated_at","Primary Key: id","Foreign Keys: staff_id → users(id), tenant_id → tenants(id)","RLS Policies: Staff can manage their own working hours, Admins can view all, Tenant isolation for authenticated users","Indexes: staff_id, tenant_id, day_of_week, is_active","","",""
"DATABASE TABLES","external_busy_times","id (UUID, PK), staff_id (FK), external_calendar_id (FK), external_event_id, event_title, start_time, end_time, last_updated_at, sync_source, event_location, postal_code, tenant_id (FK), created_at, updated_at","Primary Key: id","Foreign Keys: staff_id → users(id), external_calendar_id → external_calendars(id), tenant_id → tenants(id)","RLS Policies: Staff can view their own busy times, Admins can view all, Tenant isolation for authenticated users","Indexes: staff_id, tenant_id, start_time, end_time, external_calendar_id","","",""
"DATABASE TABLES","booking_proposals","id (UUID, PK), tenant_id (FK), category_code, duration_minutes, location_id (FK), staff_id (FK), preferred_time_slots (JSONB), first_name, last_name, email, phone, notes, status, admin_notes, created_at, updated_at, expires_at, created_by_user_id (FK)","Primary Key: id","Foreign Keys: tenant_id → tenants(id), location_id → locations(id), staff_id → users(id), created_by_user_id → users(id)","RLS Policies: Anon can insert (WITH CHECK true), Tenant isolation, Staff can view own tenant proposals, Admins can view all","Indexes: tenant_id, staff_id, status, expires_at, created_at","","",""
"DATABASE TABLES","booking_reservations","id (UUID, PK), slot_id (FK), session_id, created_at, expires_at, tenant_id (FK), user_id (FK)","Primary Key: id","Foreign Keys: slot_id → availability_slots(id), tenant_id → tenants(id), user_id → users(id)","RLS Policies: Public can insert/update for own session, Tenant isolation","Indexes: slot_id, session_id, expires_at, tenant_id","","",""
"DATABASE TABLES","examiners","id (UUID, PK), name, is_active, tenant_id (FK), created_at, updated_at","Primary Key: id","Foreign Keys: tenant_id → tenants(id)","RLS Policies: Tenant-based access, Staff can view tenant examiners, Admins can view all","Indexes: tenant_id, is_active","","",""
"DATABASE TABLES","exam_results","id (UUID, PK), appointment_id (FK), examiner_id (FK), tenant_id (FK), result_status, notes, created_at, updated_at","Primary Key: id","Foreign Keys: appointment_id → appointments(id), examiner_id → examiners(id), tenant_id → tenants(id)","RLS Policies: Tenant-based access, Staff can view tenant results, Admins can view all","Indexes: appointment_id, examiner_id, tenant_id","","",""
"DATABASE TABLES","webauthn_credentials","id (TEXT, PK), user_id (FK), tenant_id (FK), credential_id (TEXT), public_key (TEXT), counter (INT), device_type, authenticator_aaguid (TEXT), authenticator_attestation_type, authenticator_transport (TEXT[]), created_at, last_used_at, is_active, friendly_name (TEXT)","Primary Key: id","Foreign Keys: user_id → users(id), tenant_id → tenants(id)","RLS Policies: Users can manage their own credentials, Admins can manage all","Indexes: user_id, tenant_id, credential_id, is_active","","",""
"DATABASE TABLES","user_devices","id (UUID, PK), user_id (FK), device_identifier (TEXT), device_name (TEXT), ip_address, location_data (JSONB), is_trusted, last_seen_at, tenant_id (FK), created_at, updated_at","Primary Key: id","Foreign Keys: user_id → users(id), tenant_id → tenants(id)","RLS Policies: Users can manage their own devices, Admins can view all","Indexes: user_id, device_identifier, tenant_id, is_trusted","","",""
"DATABASE TABLES","staff_locations","id (UUID, PK), staff_id (FK), location_id (FK), tenant_id (FK), is_active, is_online_bookable, created_at, updated_at","Primary Key: id","Foreign Keys: staff_id → users(id), location_id → locations(id), tenant_id → tenants(id)","RLS Policies: Staff can manage their own locations, Admins can view all, Tenant isolation for authenticated users","Indexes: staff_id, location_id, tenant_id, is_online_bookable, is_active","","",""
"DATABASE TABLES","outbound_messages_queue","id (UUID, PK), tenant_id (FK), channel (TEXT), recipient_email (TEXT), recipient_phone (TEXT), subject (TEXT), body (TEXT), status (TEXT), send_at, sent_at, failed_at, error_message (TEXT), error_code (TEXT), attempt_count (INT), last_attempt_at, next_attempt_at, resend_message_id (TEXT), context_data (JSONB), created_at, updated_at","Primary Key: id","Foreign Keys: tenant_id → tenants(id)","RLS Policies: Service role only (no public access)","Indexes: tenant_id, status, send_at, channel","","",""
"DATABASE TABLES","payment_reminders","id (UUID, PK), payment_id (FK), reminder_type (TEXT), reminder_number (INT), sent_at, status (TEXT), error_message (TEXT), metadata (JSONB), created_at, appointment_id (FK), attempt_number (INT), created_by (TEXT), updated_at","Primary Key: id","Foreign Keys: payment_id → payments(id), appointment_id → appointments(id)","Unique Constraints: payment_id + reminder_type + reminder_number","RLS Policies: Service role can insert, Staff can view tenant reminders, Admins can view all","Indexes: payment_id, sent_at, reminder_type","","",""
"DATABASE TABLES","availability_recalc_queue","id (UUID, PK), staff_id (FK), tenant_id (FK), trigger (TEXT), queued_at, processed, processed_at, created_at, updated_at","Primary Key: id","Foreign Keys: staff_id → users(id), tenant_id → tenants(id)","RLS Policies: Service role full access","Indexes: staff_id, tenant_id, processed, queued_at","","",""
"DATABASE TABLES","error_logs","id (UUID, PK), tenant_id (FK), user_id (FK), severity (TEXT), message (TEXT), details (JSONB), stack (TEXT), path (TEXT), ip_address, user_agent (TEXT), created_at","Primary Key: id","Foreign Keys: tenant_id → tenants(id), user_id → users(id)","RLS Policies: Anon/Authenticated can insert, Admins can view all","Indexes: tenant_id, severity, created_at","","",""
"DATABASE TABLES","cron_jobs","id (UUID, PK), name (TEXT), last_run_at, next_run_at, status (TEXT), last_run_duration_ms (INT), last_run_error (TEXT), config (JSONB), tenant_id (FK), created_at, updated_at","Primary Key: id","Foreign Keys: tenant_id → tenants(id)","RLS Policies: Service role only","Indexes: name, status, next_run_at","","",""
"DATABASE TABLES","login_attempts","id (UUID, PK), user_id (FK), email (TEXT), ip_address, success, timestamp, user_agent (TEXT), tenant_id (FK), created_at","Primary Key: id","Foreign Keys: user_id → users(id), tenant_id → tenants(id)","RLS Policies: Service role can insert, Admins can view all","Indexes: user_id, email, ip_address, success, tenant_id","","",""
"DATABASE TABLES","rate_limit_logs","id (UUID, PK), ip_address, user_id (FK), tenant_id (FK), operation (TEXT), endpoint (TEXT), email (TEXT), timestamp, created_at","Primary Key: id","Foreign Keys: user_id → users(id), tenant_id → tenants(id)","RLS Policies: Service role can insert, Admins can view all","Indexes: ip_address, user_id, tenant_id, operation, endpoint, created_at","","",""
"DATABASE TABLES","payment_wallee_transactions","id (UUID, PK), payment_id (FK), wallee_transaction_id (TEXT), wallee_space_id (BIGINT), wallee_state (TEXT), amount_rappen (INT), currency (TEXT), failure_reason (TEXT), customer_id (TEXT), customer_email (TEXT), customer_phone (TEXT), payment_method (TEXT), payment_method_token (TEXT), created_at, updated_at, transaction_data (JSONB)","Primary Key: id","Foreign Keys: payment_id → payments(id)","RLS Policies: Service role full access","Indexes: payment_id, wallee_transaction_id, customer_id, created_at","","",""
"DATABASE TABLES","company_billing_addresses","id (UUID, PK), user_id (FK), tenant_id (FK), company_name (TEXT), contact_person (TEXT), vat_number (TEXT), street (TEXT), street_number (TEXT), zip (TEXT), city (TEXT), canton (TEXT), country (TEXT), email (TEXT), phone (TEXT), notes (TEXT), is_active (BOOLEAN), created_at, updated_at","Primary Key: id","Foreign Keys: user_id → users(id), tenant_id → tenants(id)","RLS Policies: Users can manage their own addresses, Staff can view tenant addresses, Admins can view all","Indexes: user_id, tenant_id, is_active","","",""
"DATABASE TABLES","courses","id (UUID, PK), tenant_id (FK), name (TEXT), description (TEXT), code (TEXT), start_date, end_date, is_active (BOOLEAN), price_rappen (INT), max_participants (INT), current_participants (INT), sari_managed (BOOLEAN), sari_course_id (TEXT), external_url (TEXT), created_at, updated_at","Primary Key: id","Foreign Keys: tenant_id → tenants(id)","RLS Policies: Public can view active courses, Tenant isolation","Indexes: tenant_id, is_active, sari_course_id, code","","",""
"DATABASE TABLES","course_sessions","id (UUID, PK), course_id (FK), start_time, end_time, location_id (FK), staff_id (FK), tenant_id (FK), created_at, updated_at","Primary Key: id","Foreign Keys: course_id → courses(id), location_id → locations(id), staff_id → users(id), tenant_id → tenants(id)","RLS Policies: Public can view sessions for public courses, Tenant isolation","Indexes: course_id, staff_id, location_id, tenant_id, start_time","","",""
"DATABASE TABLES","tenant_settings","tenant_id (UUID, PK), setting_key (TEXT, PK), setting_value (JSONB), created_at, updated_at","Primary Key: tenant_id + setting_key","Foreign Keys: tenant_id → tenants(id)","RLS Policies: Tenant admins can manage, Staff can read own tenant settings","Indexes: tenant_id, setting_key","","",""
"DATABASE TABLES","tenant_assets","id (UUID, PK), tenant_id (FK), asset_type (TEXT), file_url (TEXT), file_name (TEXT), mime_type (TEXT), size_bytes (INT), metadata (JSONB), created_at, updated_at","Primary Key: id","Foreign Keys: tenant_id → tenants(id)","RLS Policies: Tenant admins can manage assets, Staff can read own tenant assets","Indexes: tenant_id, asset_type","","",""
"DATABASE TABLES","tenant_required_documents","id (UUID, PK), tenant_id (FK), category_code (TEXT), document_type (TEXT), is_required (BOOLEAN), created_at, updated_at","Primary Key: id","Foreign Keys: tenant_id → tenants(id), category_code → categories(code)","RLS Policies: Tenant admins can manage, Staff can read own tenant requirements","Indexes: tenant_id, category_code, document_type","","",""
"IMPROVEMENT RECOMMENDATIONS","CRITICAL","Rate Limiting","Einige öffentliche Endpoints haben kein Rate Limiting (z.B. /api/booking/get-availability)","","","","","",""
"IMPROVEMENT RECOMMENDATIONS","CRITICAL","Input Validation","Nicht alle Endpoints validieren Inputs vollständig","","","","","",""
"IMPROVEMENT RECOMMENDATIONS","CRITICAL","Error Handling","Einige Endpoints geben zu detaillierte Fehlermeldungen zurück (Security Risk)","","","","","",""
"IMPROVEMENT RECOMMENDATIONS","CRITICAL","SQL Injection","Direkte String-Konkatenation in einigen Queries vermeiden (Supabase Query Builder nutzen)","","","","","",""
"IMPROVEMENT RECOMMENDATIONS","CRITICAL","RLS Policies","Einige Tabellen haben möglicherweise zu permissive Policies","","","","","",""
"IMPROVEMENT RECOMMENDATIONS","HIGH","Caching","Availability Slots könnten gecacht werden","","","","","",""
"IMPROVEMENT RECOMMENDATIONS","HIGH","Database Indexes","Fehlende Indexes auf häufig abgefragten Spalten","","","","","",""
"IMPROVEMENT RECOMMENDATIONS","HIGH","Transaction Management","Einige Multi-Step Operations sollten in DB Transactions sein","","","","","",""
"IMPROVEMENT RECOMMENDATIONS","HIGH","Async Operations","Email/SMS Versand sollte immer async sein (nicht blockierend)","","","","","",""
"IMPROVEMENT RECOMMENDATIONS","HIGH","Logging","Mehr strukturiertes Logging für Debugging","","","","","",""
"IMPROVEMENT RECOMMENDATIONS","MEDIUM","Code Duplication","Ähnliche Payment Logic in mehreren Composables","","","","","",""
"IMPROVEMENT RECOMMENDATIONS","MEDIUM","Type Safety","Mehr TypeScript Types für API Responses","","","","","",""
"IMPROVEMENT RECOMMENDATIONS","MEDIUM","API Documentation","OpenAPI/Swagger Dokumentation fehlt","","","","","",""
"IMPROVEMENT RECOMMENDATIONS","MEDIUM","Testing","Unit Tests für kritische Funktionen fehlen","","","","","",""
"IMPROVEMENT RECOMMENDATIONS","MEDIUM","Monitoring","Application Performance Monitoring fehlt","","","","","",""
"IMPROVEMENT RECOMMENDATIONS","LOW","Code Organization","Einige große Dateien könnten aufgeteilt werden","","","","","",""
"IMPROVEMENT RECOMMENDATIONS","LOW","Comments","Mehr JSDoc Comments für Funktionen","","","","","",""
"IMPROVEMENT RECOMMENDATIONS","LOW","Constants","Magic Numbers/Strings sollten Constants sein","","","","","",""
"IMPROVEMENT RECOMMENDATIONS","LOW","Error Messages","Konsistentere Error Message Formatierung","","","","","",""
"ABHÄNGIGKEITS-DIAGRAMM","API -> API","/api/appointments/save","Calls: /api/validate/category, /api/availability/queue-recalc, /api/reminders/send-appointment-confirmation","","","","","",""
"ABHÄNGIGKEITS-DIAGRAMM","API -> API","/api/payments/process","Calls: Wallee SDK","","","","","",""
"ABHÄNGIGKEITS-DIAGRAMM","API -> API","/api/wallee/webhook","Calls: /api/wallee/save-payment-token, /api/emails/send-course-enrollment-confirmation","","","","","",""
"ABHÄNGIGKEITS-DIAGRAMM","API -> API","/api/booking/create-appointment","Calls: /api/pricing/calculate","","","","","",""
"ABHÄNGIGKEITS-DIAGRAMM","API -> API","Viele APIs","Calls: /api/auth/current-user (für User Lookup)","","","","","",""
"ABHÄNGIGKEITS-DIAGRAMM","Composable -> API","usePayments","Calls: /api/staff/create-payment, /api/payments/update-wallee-id, /api/wallee/create-transaction, /api/appointments/update-payment-status, /api/products/list","","","","","",""
"ABHÄNGIGKEITS-DIAGRAMM","Composable -> API","useCurrentUser","Calls: /api/auth/current-user, /api/users/create-profile","","","","","",""
"ABHÄNGIGKEITS-DIAGRAMM","Composable -> API","useStudents","Calls: users Table Queries, useSmsService()","","","","","",""
"ABHÄNGIGKEITS-DIAGRAMM","Composable -> API","useAvailabilitySystem","Calls: /api/availability/queue-recalc, /api/booking/get-availability","","","","","",""
"ABHÄNGIGKEITS-DIAGRAMM","Composable -> API","useSARISync","Calls: /api/sari/* Endpoints","","","","","",""
"ABHÄNGIGKEITS-DIAGRAMM","Component -> Composable","Payment Components","Calls: usePayments","","","","","",""
"ABHÄNGIGKEITS-DIAGRAMM","Component -> Composable","Event Modal","Calls: useEventModalApi, useEventModalForm, useEventModalHandlers","","","","","",""
"ABHÄNGIGKEITS-DIAGRAMM","Component -> Composable","Student Components","Calls: useStudents","","","","","",""
"ABHÄNGIGKEITS-DIAGRAMM","Component -> Composable","Calendar Components","Calls: useCalendarCache, useAvailabilitySystem","","","","","",""
