// PDF Receipt Generation API

import { setHeader, send, readBody } from 'h3'
import { getSupabaseAdmin } from '~/utils/supabase'

let puppeteer: any
async function getPuppeteer() {
  if (!puppeteer) {
    puppeteer = await import('puppeteer')
  }
  return puppeteer
}

interface ReceiptRequest { paymentId?: string; paymentIds?: string[] }

async function generateReceiptHTML(payment: any, supabase: any, tenant: any, primary: string, secondary: string, t: any) {
  // Load appointment details separately
  let appointment: any = null
  let user: any = null
  let products: Array<{ name: string; description?: string; quantity: number; unit_price_rappen: number; total_price_rappen: number; }> = []
  
  if (payment.appointment_id) {
    const { data: appointmentData, error: aErr } = await supabase
      .from('appointments')
      .select(`
        id,
        title,
        start_time,
        end_time,
        duration_minutes,
        type,
        status,
        event_type_code,
        deleted_at,
        deletion_reason,
        cancellation_reason_id,
        cancellation_type,
        cancellation_charge_percentage,
        cancellation_credit_hours,
        cancellation_policy_applied,
        user_id
      `)
      .eq('id', payment.appointment_id)
      .single()
    
    if (!aErr && appointmentData) {
      appointment = appointmentData
      
      // Load user details (including language)
      if (appointment.user_id) {
        const { data: userData, error: uErr } = await supabase
          .from('users')
          .select('first_name, last_name, email, phone, street, street_nr, zip, city, language')
          .eq('id', appointment.user_id)
          .single()
        
        if (!uErr && userData) {
          user = userData
        }
      }
    }

    // Load products via discount_sales -> product_sales chain (optional)
    try {
      const { data: discountSale } = await supabase
        .from('discount_sales')
        .select('id')
        .eq('appointment_id', payment.appointment_id)
        .maybeSingle()
      if (discountSale?.id) {
        const { data: ps } = await supabase
          .from('product_sales')
          .select(`id, quantity, unit_price_rappen, total_price_rappen, products ( name, description )`)
          .eq('product_sale_id', discountSale.id)
        products = (ps || []).map((row: any) => ({
          name: row.products?.name || 'Produkt',
          description: row.products?.description || '',
          quantity: row.quantity || 1,
          unit_price_rappen: row.unit_price_rappen || 0,
          total_price_rappen: row.total_price_rappen || 0
        }))
      }
    } catch (productErr) {
      console.warn('‚ö†Ô∏è Could not load products:', productErr)
    }
  }

  // Build customer name
  const customerName = user 
    ? `${user.first_name || ''} ${user.last_name || ''}`.trim() 
    : 'Kunde'

  // Build customer address
  const customerAddress = []
  if (user?.street && user?.street_nr) {
    customerAddress.push(`${user.street} ${user.street_nr}`)
  }
  if (user?.zip && user?.city) {
    customerAddress.push(`${user.zip} ${user.city}`)
  }
  const customerFullAddress = customerAddress.join(', ')

  const customerEmail = user?.email || ''
  const customerPhone = user?.phone || ''

  // Build tenant address
  const tenantAddress = []
  if (tenant?.address) {
    tenantAddress.push(tenant.address)
  }
  const fullAddress = tenantAddress.join(', ')

  const companyName = tenant?.legal_company_name || tenant?.name || 'Unternehmen'
  const tenantEmail = tenant?.email || ''
  const tenantPhone = tenant?.phone || ''

  // Load logo
  let logoSrc = null
  let logoDataUrl = null
  if (tenant?.logo_url) {
    logoSrc = tenant.logo_url
    try {
      const logoRes = await fetch(logoSrc)
      if (logoRes.ok) {
        const logoBuffer = await logoRes.arrayBuffer()
        const logoBase64 = Buffer.from(logoBuffer).toString('base64')
        const logoMime = logoRes.headers.get('content-type') || 'image/png'
        logoDataUrl = `data:${logoMime};base64,${logoBase64}`
      }
    } catch (logoErr) {
      console.warn('‚ö†Ô∏è Could not load logo:', logoErr)
    }
  }

  // Calculate amounts
  const lesson = (payment.lesson_price_rappen || 0) / 100
  const adminFee = (payment.admin_fee_rappen || 0) / 100
  const discountAmount = (payment.discount_amount_rappen || 0) / 100
  const amount = lesson + adminFee - discountAmount + (products.reduce((sum, p) => sum + (p.total_price_rappen / 100), 0))

  // Format appointment details
  const appointmentDate = appointment && appointment.start_time 
    ? new Date(appointment.start_time).toLocaleDateString('de-CH')
    : ''
  const appointmentTime = appointment && appointment.start_time
    ? new Date(appointment.start_time).toLocaleTimeString('de-CH', { hour: '2-digit', minute: '2-digit' })
    : ''
  const appointmentDuration = appointment?.duration_minutes || 0

  // Translate appointment details using the provided t function
  const eventTypeTranslated = appointment ? t(`eventType.${appointment.event_type_code || 'lesson'}`) : ''
  const statusTranslated = appointment ? t(`status.${appointment.status || 'pending'}`) : ''
  const isCancelled = appointment && (appointment.status === 'cancelled' || appointment.deleted_at)
  const cancellationDate = appointment && appointment.deleted_at ? new Date(appointment.deleted_at).toLocaleDateString('de-CH') : '-'
  const cancellationReason = appointment ? (appointment.deletion_reason || appointment.cancellation_type || appointment.cancellation_reason_id || '-') : '-'
  const isCharged = appointment && (Number(appointment.cancellation_charge_percentage || 0) > 0 || appointment.cancellation_policy_applied)

  return `
    <div class="doc" style="page-break-after: always;">
      <div class="header">
        <div class="header-left">
          <div class="title">${t('receipt.title')}</div>
          <div style="margin-top:12px;">
            <div class="label">${t('receipt.customer')}</div>
            <div class="value">${customerName}</div>
            ${customerFullAddress ? `<div class="address-left">${customerFullAddress}</div>` : ''}
            ${customerEmail || customerPhone ? `<div class="contact-left">${customerEmail ? customerEmail : ''}${customerEmail && customerPhone ? '<br/>' : ''}${customerPhone ? customerPhone : ''}</div>` : ''}
            <div style="margin-top:8px;">
              <div class="label">${t('receipt.date')}</div>
              <div class="value" style="display:inline;">${new Date(payment.paid_at || payment.created_at).toLocaleDateString('de-CH')}</div>
            </div>
          </div>
        </div>
        <div class="header-right">
          ${logoSrc ? `<img class="logo" src="${logoDataUrl || logoSrc}" alt="Logo"/>` : ''}
          ${companyName ? `<div class="value">${companyName}</div>` : ''}
          ${fullAddress ? `<div class="address">${fullAddress}</div>` : ''}
          ${tenantEmail || tenantPhone ? `<div class="contact">${tenantEmail ? tenantEmail : ''}${tenantEmail && tenantPhone ? '<br/>' : ''}${tenantPhone ? tenantPhone : ''}</div>` : ''}
        </div>
      </div>
      
      <div class="section">
        <div class="section-title">${t('receipt.costBreakdown')}</div>
        ${appointment ? `
        <div class="row">
          <div class="label">
            ${eventTypeTranslated} - ${statusTranslated} - ${appointmentDate} ${appointmentTime} - ${appointmentDuration} ${t('receipt.minutes')}
            ${isCancelled ? `<br/><span style=\"font-size:12px; color:#6b7280;\">${t('receipt.cancelled')}: ${cancellationDate} | ${t('receipt.reason')}: ${cancellationReason} | ${t('receipt.charged')}: ${isCharged ? t('receipt.yes') : t('receipt.no')}</span>` : ''}
          </div>
          <div class="value">CHF ${lesson.toFixed(2)}</div>
        </div>
        ` : `
        <div class="row"><div class="label">${t('receipt.baseAmount')}</div><div class="value">CHF ${lesson.toFixed(2)}</div></div>
        `}
        <div class="row"><div class="label">${t('receipt.adminFee')}</div><div class="value">CHF ${adminFee.toFixed(2)}</div></div>
        ${products && products.length > 0 ? products.map(p => `
        <div class="row">
          <div class="label">${p.name} √ó ${p.quantity}</div>
          <div class="value">CHF ${(Number(p.total_price_rappen || 0)/100).toFixed(2)}</div>
        </div>
        `).join('') : ''}
        ${Number(payment.discount_amount_rappen || 0) > 0 ? `
          <div class="row" style=\"color:#059669;\">
            <div class="label">${t('receipt.discount')}</div>
            <div class="value">- CHF ${(Number(payment.discount_amount_rappen)/100).toFixed(2)}</div>
          </div>
        ` : ''}
        <div class="row" style="margin-top:12px; padding-top:8px; border-top:1px solid #e5e7eb;"><div class="label">${t('receipt.totalAmount')}</div><div class="amount">CHF ${amount.toFixed(2)}</div></div>
      </div>
      
      <div class="section">
        <div class="muted">${t('receipt.footer', { email: tenantEmail || 'den Support' })}</div>
      </div>
    </div>
  `
}

export default defineEventHandler(async (event) => {
  try {
    logger.debug('üìÑ Receipt API called')
    
    const { paymentId, paymentIds }: ReceiptRequest = await readBody(event)
    
    // Determine which payments to process
    const ids = paymentIds && paymentIds.length > 0 ? paymentIds : (paymentId ? [paymentId] : [])
    
    if (ids.length === 0) {
      console.error('‚ùå No payment ID(s) provided')
      throw new Error('Payment ID(s) is required')
    }

    logger.debug('üìÑ Generating receipt(s) for payment(s):', ids)

    const supabase = getSupabaseAdmin()

    // Load all payments
    const { data: payments, error: pErr } = await supabase
      .from('payments')
      .select('*')
      .in('id', ids)

    if (pErr) {
      console.error('‚ùå Error loading payments:', pErr)
      throw new Error(`Payments not found: ${pErr.message}`)
    }
    
    if (!payments || payments.length === 0) {
      throw new Error('Payments not found')
    }

    // Load tenant branding (once for all payments)
    const firstPayment = payments[0]
    const tenantId = firstPayment.tenant_id || firstPayment.metadata?.tenant_id || null
    let tenant: any = null
    if (tenantId) {
      try {
        const { data, error } = await supabase
          .from('tenants')
          .select('name, legal_company_name, primary_color, secondary_color, logo_url, logo_square_url, logo_wide_url, address, contact_email, contact_phone')
          .eq('id', tenantId)
          .maybeSingle()
        if (error) {
          console.error('‚ùå Tenant fetch error:', error)
        }
        tenant = data
      } catch (tErr) {
        console.error('‚ùå Tenant fetch exception:', tErr)
      }
    }

    const primary = tenant?.primary_color || '#2563eb'
    const secondary = tenant?.secondary_color || '#6b7280'

    // Translation helper function (needs to be passed to generateReceiptHTML)
    const t = (key: string, params?: Record<string, any>) => {
      const translations: Record<string, any> = {
        'receipt.title': 'Quittung',
        'receipt.customer': 'Kunde',
        'receipt.date': 'Datum',
        'receipt.costBreakdown': 'Kostenaufstellung',
        'receipt.baseAmount': 'Basisbetrag',
        'receipt.adminFee': 'Administrationsgeb√ºhr',
        'receipt.discount': 'Rabatt',
        'receipt.totalAmount': 'Gesamtbetrag',
        'receipt.minutes': 'Minuten',
        'receipt.cancelled': 'Storniert',
        'receipt.reason': 'Grund',
        'receipt.charged': 'Berechnet',
        'receipt.yes': 'Ja',
        'receipt.no': 'Nein',
        'receipt.footer': `Bei Fragen wenden Sie sich bitte an ${tenant?.contact_email || 'den Support'}.`,
        'eventType.lesson': 'Fahrlektion',
        'status.scheduled': 'Geplant',
        'status.completed': 'Abgeschlossen',
        'status.cancelled': 'Storniert'
      }
      const value = translations[key] || key
      if (typeof value !== 'string') return key
      if (params) {
        return value.replace(/{(\w+)}/g, (match: string, param: string) => params[param] || match)
      }
      return value
    }

    // Generate HTML for each payment
    const receiptHTMLs = await Promise.all(
      payments.map(payment => generateReceiptHTML(payment, supabase, tenant, primary, secondary, t))
    )

    // Combine all receipts into one HTML document
    const html = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8" />
        <style>
          :root { --primary:${primary}; --secondary:${secondary}; }
          body { font-family: Arial, sans-serif; color:#111827; margin:0; }
          .doc { max-width:720px; margin:24px auto; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; }
          .header { display:flex; align-items:flex-start; justify-content:space-between; padding:20px 24px; border-bottom:1px solid #e5e7eb; background:linear-gradient(90deg,#fff,#f9fafb); }
          .header-left { display:flex; flex-direction:column; gap:8px; }
          .header-right { display:flex; flex-direction:column; align-items:flex-end; gap:8px; }
          .logo { height:60px; width:auto; object-fit:contain; max-width:150px; }
          .title { font-size:24px; font-weight:800; color:var(--primary); }
          .subtitle { font-size:14px; color:var(--secondary); margin-top:2px; }
          .address { font-size:12px; color:#6b7280; line-height:1.3; text-align:right; }
          .contact { font-size:12px; color:#6b7280; line-height:1.3; text-align:right; }
          .address-left { font-size:12px; color:#6b7280; line-height:1.3; text-align:left; }
          .contact-left { font-size:12px; color:#6b7280; line-height:1.3; text-align:left; }
          .section { padding:20px 24px; border-top:1px solid #f3f4f6; }
          .section-title { font-size:16px; font-weight:600; color:var(--primary); margin-bottom:12px; }
          .row { display:flex; justify-content:space-between; margin:8px 0; font-size:14px; }
          .label { color:#6b7280; font-weight:500; }
          .value { font-weight:600; }
          .amount { font-weight:700; color:var(--primary); font-size:18px; }
          .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
          .muted { color:#6b7280; font-size:12px; line-height:1.4; }
          .appointment-details { background:#f8fafc; border-radius:8px; padding:16px; margin:12px 0; }
          .customer-info { background:#f0f9ff; border-radius:8px; padding:16px; margin:12px 0; }
        </style>
      </head>
      <body>
        ${receiptHTMLs.join('')}
      </body>
    </html>
    `

    // Remove the last page-break
    const finalHtml = html.replace(/style="page-break-after: always;">/g, (match, offset) => {
      // If this is the last occurrence, remove it
      const lastIndex = html.lastIndexOf(match)
      return offset === lastIndex ? '>' : match
    })

    logger.debug('üìÑ Generating PDF with Puppeteer...')
    
    let browser: any
    try {
      const { default: Puppeteer } = await getPuppeteer()
      logger.debug('‚úÖ Puppeteer loaded successfully')
      
      browser = await Puppeteer.launch({ 
        args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage'],
        headless: true
      })
      logger.debug('‚úÖ Browser launched successfully')
      
      const page = await browser.newPage()
      await page.setContent(finalHtml, { waitUntil: 'networkidle0' })
      
      logger.debug('üìÑ Converting to PDF...')
      const pdfBuffer = await page.pdf({ 
        format: 'A4', 
        printBackground: true, 
        margin: { top: '10mm', right: '10mm', bottom: '10mm', left: '10mm' } 
      })
      
      await page.close()
      await browser.close()
      
      logger.debug('‚úÖ PDF generated successfully, size:', pdfBuffer.length, 'bytes')
      
      setHeader(event, 'Content-Type', 'application/pdf')
      const filename = payments.length === 1 
        ? `Quittung_${payments[0].id}.pdf`
        : `Alle_Quittungen_${new Date().toISOString().split('T')[0]}.pdf`
      setHeader(event, 'Content-Disposition', `attachment; filename="${filename}"`)
      return send(event, pdfBuffer)
    } catch (pdfError: any) {
      console.error('‚ùå PDF generation error:', pdfError)
      if (browser) {
        await browser.close()
      }
      throw new Error(`PDF generation failed: ${pdfError.message}`)
    }
  } catch (error: any) {
    console.error('‚ùå Receipt generation failed:', error)
    setHeader(event, 'Content-Type', 'application/json')
    return { success:false, error: error.message || 'Receipt generation failed' }
  }
})

// .env Variables f√ºr Wallee
/*
# Wallee Configuration
        .select(`
          id,
          title,
          start_time,
          end_time,
          duration_minutes,
          type,
          status,
          event_type_code,
          deleted_at,
          deletion_reason,
          cancellation_reason_id,
          cancellation_type,
          cancellation_charge_percentage,
          cancellation_credit_hours,
          cancellation_policy_applied,
          user_id
        `)
        .eq('id', payment.appointment_id)
        .single()
      
      if (!aErr && appointmentData) {
        appointment = appointmentData
        
        // Load user details (including language)
        if (appointment.user_id) {
          const { data: userData, error: uErr } = await supabase
            .from('users')
            .select('first_name, last_name, email, phone, street, street_nr, zip, city, language')
            .eq('id', appointment.user_id)
            .single()
          
          if (!uErr && userData) {
            user = userData
          }
        }
      }

      // Load products via discount_sales -> product_sales chain (optional)
      try {
        const { data: discountSale } = await supabase
          .from('discount_sales')
          .select('id')
          .eq('appointment_id', payment.appointment_id)
          .maybeSingle()
        if (discountSale?.id) {
          const { data: ps } = await supabase
            .from('product_sales')
            .select(`id, quantity, unit_price_rappen, total_price_rappen, products ( name, description )`)
            .eq('product_sale_id', discountSale.id)
          products = (ps || []).map((row: any) => ({
            name: row.products?.name || 'Produkt',
            description: row.products?.description || '',
            quantity: row.quantity || 1,
            unit_price_rappen: row.unit_price_rappen || 0,
            total_price_rappen: row.total_price_rappen || 0
          }))
        }
      } catch {}
    }

    // Load tenant branding (optional)
    const tenantId = payment.tenant_id || payment.metadata?.tenant_id || null
    let tenant: any = null
    if (tenantId) {
      try {
        const { data, error } = await supabase
          .from('tenants')
          .select('name, legal_company_name, primary_color, secondary_color, logo_url, logo_square_url, logo_wide_url, address, contact_email, contact_phone')
          .eq('id', tenantId)
          .maybeSingle()
        if (error) {
          console.error('‚ùå Tenant fetch error:', error)
        }
        tenant = data
      } catch (tErr) {
        console.error('‚ùå Tenant fetch exception:', tErr)
      }
    }

    // Build HTML (simple, neutral, tenant-aware)
    const primary = tenant?.primary_color || '#2563eb'
    const secondary = tenant?.secondary_color || '#6b7280'
    const companyName = tenant?.legal_company_name || tenant?.name || 'Quittung'
    const logoSrc = tenant?.logo_url || tenant?.logo_square_url || tenant?.logo_wide_url || ''
    let logoDataUrl = ''
    if (logoSrc) {
      try {
        const res = await fetch(logoSrc)
        if (res.ok) {
          const contentType = res.headers.get('content-type') || 'image/png'
          const arrBuf = await res.arrayBuffer()
          const base64 = Buffer.from(arrBuf).toString('base64')
          logoDataUrl = `data:${contentType};base64,${base64}`
        }
      } catch {}
    }
    const tenantEmail = tenant?.contact_email || ''
    const tenantPhone = tenant?.contact_phone || ''
    
    // Build tenant address
    const tenantAddress = []
    if (tenant?.address) {
      tenantAddress.push(tenant.address)
    }
    const fullAddress = tenantAddress.join(', ')

    // Debug logging for tenant header rendering
    logger.debug('üßæ Receipt header debug:', {
      tenantId,
      tenantLoaded: !!tenant,
      companyName,
      logoSrc,
      logoDataUrlLen: logoDataUrl ? logoDataUrl.length : 0,
      fullAddress,
      tenantEmail,
      tenantPhone
    })

    const amount = Number(payment.total_amount_rappen || 0) / 100
    const adminFee = Number(payment.admin_fee_rappen || 0) / 100
    const lesson = Number(payment.lesson_price_rappen || 0) / 100

    // Extract appointment and user data
    const appointmentTitle = appointment?.title || 'Fahrstunde'
    const appointmentDate = appointment?.start_time ? new Date(appointment.start_time).toLocaleDateString('de-CH') : '-'
    const appointmentTime = appointment?.start_time ? new Date(appointment.start_time).toLocaleTimeString('de-CH', { hour: '2-digit', minute: '2-digit' }) : '-'
    const appointmentDuration = appointment?.duration_minutes || 45
    const customerName = user ? `${user.first_name || ''} ${user.last_name || ''}`.trim() : '-'
    const customerEmail = user?.email || '-'
    const customerPhone = user?.phone || ''
    const customerAddressParts: string[] = []
    if (user?.street && (user as any).street_nr) {
      customerAddressParts.push(`${user.street} ${(user as any).street_nr}`)
    }
    if ((user as any).zip && (user as any).city) {
      customerAddressParts.push(`${(user as any).zip} ${(user as any).city}`)
    }
    const customerFullAddress = customerAddressParts.join(', ')

    // Load user language and translations
    const userLang = (user as any)?.language || 'de'
    let translations: any = {}
    
    try {
      const fs = await import('fs/promises')
      const path = await import('path')
      const localePath = path.join(process.cwd(), 'locales', `${userLang}.json`)
      const localeContent = await fs.readFile(localePath, 'utf-8')
      translations = JSON.parse(localeContent)
    } catch (err) {
      console.warn(`‚ö†Ô∏è Could not load translations for language ${userLang}, using default (de)`, err)
      // Fallback to German
      try {
        const fs = await import('fs/promises')
        const path = await import('path')
        const localePath = path.join(process.cwd(), 'locales', 'de.json')
        const localeContent = await fs.readFile(localePath, 'utf-8')
        translations = JSON.parse(localeContent)
      } catch (fallbackErr) {
        console.error('‚ùå Could not load fallback translations', fallbackErr)
        // Use empty translations object as last resort
        translations = {}
      }
    }

    // Translation helper function
    const t = (key: string, params?: Record<string, string>): string => {
      const keys = key.split('.')
      let value: any = translations
      for (const k of keys) {
        value = value?.[k]
        if (value === undefined) return key
      }
      if (typeof value !== 'string') return key
      if (params) {
        return value.replace(/{(\w+)}/g, (match: string, param: string) => params[param] || match)
      }
      return value
    }

    // Translate appointment details
    const eventTypeTranslated = appointment ? t(`eventType.${appointment.event_type_code || 'lesson'}`) : ''
    const statusTranslated = appointment ? t(`status.${appointment.status || 'pending'}`) : ''
    const isCancelled = appointment && (appointment.status === 'cancelled' || appointment.deleted_at)
    const cancellationDate = appointment && appointment.deleted_at ? new Date(appointment.deleted_at).toLocaleDateString('de-CH') : '-'
    const cancellationReason = appointment ? (appointment.deletion_reason || appointment.cancellation_type || appointment.cancellation_reason_id || '-') : '-'
    const isCharged = appointment && (Number(appointment.cancellation_charge_percentage || 0) > 0 || appointment.cancellation_policy_applied)

    const html = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8" />
        <style>
          :root { --primary:${primary}; --secondary:${secondary}; }
          body { font-family: Arial, sans-serif; color:#111827; margin:0; }
          .doc { max-width:720px; margin:24px auto; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; }
          .header { display:flex; align-items:flex-start; justify-content:space-between; padding:20px 24px; border-bottom:1px solid #e5e7eb; background:linear-gradient(90deg,#fff,#f9fafb); }
          .header-left { display:flex; flex-direction:column; gap:8px; }
          .header-right { display:flex; flex-direction:column; align-items:flex-end; gap:8px; }
          .logo { height:60px; width:auto; object-fit:contain; max-width:150px; }
          .title { font-size:24px; font-weight:800; color:var(--primary); }
          .subtitle { font-size:14px; color:var(--secondary); margin-top:2px; }
          .address { font-size:12px; color:#6b7280; line-height:1.3; text-align:right; }
          .contact { font-size:12px; color:#6b7280; line-height:1.3; text-align:right; }
          .address-left { font-size:12px; color:#6b7280; line-height:1.3; text-align:left; }
          .contact-left { font-size:12px; color:#6b7280; line-height:1.3; text-align:left; }
          .section { padding:20px 24px; border-top:1px solid #f3f4f6; }
          .section-title { font-size:16px; font-weight:600; color:var(--primary); margin-bottom:12px; }
          .row { display:flex; justify-content:space-between; margin:8px 0; font-size:14px; }
          .label { color:#6b7280; font-weight:500; }
          .value { font-weight:600; }
          .amount { font-weight:700; color:var(--primary); font-size:18px; }
          .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
          .muted { color:#6b7280; font-size:12px; line-height:1.4; }
          .appointment-details { background:#f8fafc; border-radius:8px; padding:16px; margin:12px 0; }
          .customer-info { background:#f0f9ff; border-radius:8px; padding:16px; margin:12px 0; }
        </style>
      </head>
      <body>
        <div class="doc">
          <div class="header">
            <div class="header-left">
              <div class="title">${t('receipt.title')}</div>
              <div style="margin-top:12px;">
                <div class="label">${t('receipt.customer')}</div>
                <div class="value">${customerName}</div>
                ${customerFullAddress ? `<div class="address-left">${customerFullAddress}</div>` : ''}
                ${customerEmail || customerPhone ? `<div class="contact-left">${customerEmail ? customerEmail : ''}${customerEmail && customerPhone ? '<br/>' : ''}${customerPhone ? customerPhone : ''}</div>` : ''}
                <div style="margin-top:8px;">
                  <div class="label">${t('receipt.date')}</div>
                  <div class="value" style="display:inline;">${new Date(payment.paid_at || payment.created_at).toLocaleDateString('de-CH')}</div>
                </div>
              </div>
            </div>
            <div class="header-right">
              ${logoSrc ? `<img class="logo" src="${logoDataUrl || logoSrc}" alt="Logo"/>` : ''}
              ${companyName ? `<div class="value">${companyName}</div>` : ''}
              ${fullAddress ? `<div class="address">${fullAddress}</div>` : ''}
              ${tenantEmail || tenantPhone ? `<div class="contact">${tenantEmail ? tenantEmail : ''}${tenantEmail && tenantPhone ? '<br/>' : ''}${tenantPhone ? tenantPhone : ''}</div>` : ''}
            </div>
          </div>
          
          <div class="section">
            <div class="section-title">${t('receipt.costBreakdown')}</div>
            ${appointment ? `
            <div class="row">
              <div class="label">
                ${eventTypeTranslated} - ${statusTranslated} - ${appointmentDate} ${appointmentTime} - ${appointmentDuration} ${t('receipt.minutes')}
                ${isCancelled ? `<br/><span style=\"font-size:12px; color:#6b7280;\">${t('receipt.cancelled')}: ${cancellationDate} | ${t('receipt.reason')}: ${cancellationReason} | ${t('receipt.charged')}: ${isCharged ? t('receipt.yes') : t('receipt.no')}</span>` : ''}
              </div>
              <div class="value">CHF ${lesson.toFixed(2)}</div>
            </div>
            ` : `
            <div class="row"><div class="label">${t('receipt.baseAmount')}</div><div class="value">CHF ${lesson.toFixed(2)}</div></div>
            `}
            <div class="row"><div class="label">${t('receipt.adminFee')}</div><div class="value">CHF ${adminFee.toFixed(2)}</div></div>
            ${products && products.length > 0 ? products.map(p => `
            <div class="row">
              <div class="label">${p.name} √ó ${p.quantity}</div>
              <div class="value">CHF ${(Number(p.total_price_rappen || 0)/100).toFixed(2)}</div>
            </div>
            `).join('') : ''}
            ${Number(payment.discount_amount_rappen || 0) > 0 ? `
              <div class="row" style=\"color:#059669;\">
                <div class="label">${t('receipt.discount')}</div>
                <div class="value">- CHF ${(Number(payment.discount_amount_rappen)/100).toFixed(2)}</div>
              </div>
            ` : ''}
            <div class="row" style="margin-top:12px; padding-top:8px; border-top:1px solid #e5e7eb;"><div class="label">${t('receipt.totalAmount')}</div><div class="amount">CHF ${amount.toFixed(2)}</div></div>
          </div>
          
          <div class="section">
            <div class="muted">${t('receipt.footer', { email: tenantEmail || 'den Support' })}</div>
          </div>
        </div>
      </body>
    </html>
    `

    logger.debug('üìÑ Generating PDF with Puppeteer...')
    
    let browser: any
    try {
      const { default: Puppeteer } = await getPuppeteer()
      logger.debug('‚úÖ Puppeteer loaded successfully')
      
      browser = await Puppeteer.launch({ 
        args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage'],
        headless: true
      })
      logger.debug('‚úÖ Browser launched successfully')
      
      const page = await browser.newPage()
      await page.setContent(html, { waitUntil: 'networkidle0' })
      
      logger.debug('üìÑ Converting to PDF...')
      const pdfBuffer = await page.pdf({ 
        format: 'A4', 
        printBackground: true, 
        margin: { top: '10mm', right: '10mm', bottom: '10mm', left: '10mm' } 
      })
      
      await page.close()
      await browser.close()
      
      logger.debug('‚úÖ PDF generated successfully, size:', pdfBuffer.length, 'bytes')
      
      setHeader(event, 'Content-Type', 'application/pdf')
      setHeader(event, 'Content-Disposition', `attachment; filename="Quittung_${payment.id}.pdf"`)
      return send(event, pdfBuffer)
    } catch (pdfError: any) {
      console.error('‚ùå PDF generation error:', pdfError)
      if (browser) {
        await browser.close()
      }
      throw new Error(`PDF generation failed: ${pdfError.message}`)
    }
  } catch (error: any) {
    console.error('‚ùå Receipt generation failed:', error)
    setHeader(event, 'Content-Type', 'application/json')
    return { success:false, error: error.message || 'Receipt generation failed' }
  }
})

// .env Variables f√ºr Wallee
/*
# Wallee Configuration
WALLEE_BASE_URL=https://app-wallee.com
WALLEE_SPACE_ID=your_space_id_here
WALLEE_USER_ID=your_user_id_here
WALLEE_API_SECRET=your_api_secret_here
WALLEE_TWINT_METHOD_ID=your_twint_method_configuration_id

# Webhook URLs (f√ºr Wallee Dashboard)
# Success URL: https://yourdomain.com/payment/success
# Failed URL: https://yourdomain.com/payment/failed
# Webhook URL: https://yourdomain.com/api/wallee/webhook
*/