/**
 * API Endpoint: /api/admin/preload-plz-distances
 * 
 * PURPOSE:
 * Preloads all possible travel times between postal codes for selected cantons
 * into the plz_distance_cache table using Google Distance API.
 * This reduces latency for subsequent availability calculations and bookings.
 * 
 * SECURITY:
 * - Admin/Superadmin only
 * - Requires authentication
 * 
 * USAGE:
 * POST /api/admin/preload-plz-distances
 * Body: {
 *   "cantons": ["Z√ºrich", "Aargau", "St.Gallen", "Schwyz"]
 * }
 */

import { defineEventHandler, readBody, createError } from 'h3'
import { getSupabaseAdmin } from '~/server/utils/supabase-admin'
import { getAuthenticatedUser } from '~/server/utils/auth'
import { logger } from '~/utils/logger'
import { availabilityCalculator } from '~/server/services/availability-calculator'

interface PreloadRequest {
  cantons: string[]
}

// Placeholder for actual postal code data (would come from a more robust source)
// For now, these are examples. Real implementation would need a comprehensive list.
const allSwissPostalCodes: Record<string, string[]> = {
  'Z√ºrich': ['8000', '8001', '8002', '8003', '8004', '8005', '8006', '8008', '8032', '8037', '8038', '8041', '8044', '8045', '8046', '8048', '8049', '8050', '8051', '8052', '8053', '8055', '8057', '8064', '8092', '8093', '8102', '8103', '8104', '8105', '8106', '8107', '8108', '8112', '8113', '8114', '8117', '8118', '8121', '8122', '8123', '8124', '8125', '8126', '8127', '8132', '8133', '8134', '8135', '8136', '8142', '8143', '8152', '8153', '8154', '8155', '8156', '8157', '8162', '8164', '8165', '8166', '8172', '8173', '8174', '8175', '8180', '8181', '8182', '8184', '8185', '8187', '8192', '8193', '8194', '8200', '8201', '8207', '8208', '8212', '8213', '8214', '8215', '8216', '8217', '8218', '8219', '8222', '8223', '8224', '8226', '8227', '8230', '8232', '8233', '8234', '8235', '8236', '8238', '8240', '8241', '8242', '8243', '8245', '8246', '8247', '8248', '8249', '8252', '8253', '8254', '8255', '8259', '8260', '8261', '8262', '8263', '8264', '8265', '8266', '8267', '8268', '8272', '8273', '8274', '8276', '8277', '8280', '8281', '8283', '8284', '8285', '8286', '8287', '8288', '8290', '8292', '8293', '8294', '8295', '8299', '8302', '8303', '8304', '8305', '8307', '8308', '8311', '8312', '8314', '8315', '8317', '8318', '8319', '8320', '8321', '8322', '8323', '8324', '8325', '8326', '8327', '8328', '8329', '8330', '8332', '8335', '8336', '8340', '8342', '8343', '8344', '8345', '8352', '8353', '8354', '8355', '8356', '8357', '8360', '8362', '8370', '8371', '8374', '8375', '8382', '8383', '8386', '8387', '8388', '8389', '8390', '8400', '8401', '8404', '8405', '8406', '8408', '8412', '8413', '8414', '8415', '8416', '8418', '8421', '8422', '8424', '8426', '8427', '8428', '8442', '8444', '8447', '8450', '8451', '8452', '8453', '8454', '8455', '8456', '8457', '8458', '8459', '8460', '8461', '8462', '8463', '8464', '8466', '8467', '8468', '8469', '8471', '8472', '8474', '8477', '8478', '8479', '8480', '8482', '8483', '8484', '8486', '8487', '8488', '8489', '8492', '8493', '8494', '8499', '8500', '8501', '8502', '8503', '8504', '8505', '8506', '8507', '8508', '8512', '8514', '8522', '8523', '8524', '8525', '8526', '8532', '8533', '8534', '8535', '8536', '8537', '8538', '8539', '8542', '8543', '8544', '8545', '8546', '8548', '8552', '8553', '8554', '8556', '8557', '8560', '8561', '8562', '8563', '8564', '8565', '8566', '8567', '8568', '8569', '8570', '8572', '8573', '8580', '8581', '8582', '8583', '8584', '8585', '8586', '8587', '8592', '8593', '8594', '8595', '8596', '8597', '8598', '8599', '8600', '8602', '8603', '8604', '8605', '8606', '8607', '8608', '8610', '8612', '8614', '8615', '8616', '8617', '8618', '8620', '8623', '8624', '8625', '8626', '8627', '8630', '8632', '8633', '8634', '8635', '8636', '8640', '8645', '8652', '8653', '8654', '8655', '8656', '8657', '8658', '8659', '8661', '8662', '8663', '8664', '8665', '8666', '8668', '8670', '8685', '8687', '8688', '8689', '8690', '8692', '8693', '8694', '8700', '8702', '8703', '8704', '8706', '8707', '8712', '8713', '8714', '8716', '8717', '8718', '8719', '8722', '8723', '8725', '8726', '8727', '8730', '8732', '8733', '8734', '8735', '8737', '8740', '8745', '8750', '8751', '8800', '8802', '8803', '8804', '8805', '8806', '8807', '8808', '8809', '8810', '8816', '8820', '8832', '8833', '8834', '8835', '8836', '8840', '8841', '8842', '8843', '8844', '8845', '8846', '8847', '8849', '8852', '8853', '8854', '8855', '8856', '8857', '8862', '8863', '8864', '8865', '8866', '8867', '8868', '8872', '8873', '8874', '8875', '8876', '8877', '8878', '8880', '8881', '8882', '8883', '8885', '8886', '8887', '8888', '8889', '8890', '8892', '8893', '8894', '8895', '8896', '8897', '8900', '8903', '8904', '8905', '8906', '8907', '8908', '8909', '8910', '8912', '8913', '8914', '8915', '8916', '8917', '8918', '8919', '8922', '8923', '8924', '8925', '8926', '8932', '8933', '8934', '8942', '8951', '8952', '8953', '8954', '8955', '8956', '8957', '8962', '8964', '8965', '8966', '8967', '8968', '8969', '8970', '8971', '8972', '8973', '8974', '8975', '8976', '8978', '8981', '8982', '8983', '8984', '8985', '8986', '8987', '8988', '8989', '8991', '8992', '8995', '8996', '8997', '8998'],
  'Aargau': ['5000', '5001', '5002', '5003', '5004', '5012', '5013', '5014', '5015', '5016', '5017', '5018', '5022', '5023', '5024', '5025', '5026', '5027', '5028', '5032', '5033', '5034', '5035', '5036', '5037', '5040', '5042', '5043', '5044', '5052', '5053', '5054', '5056', '5057', '5058', '5062', '5063', '5064', '5070', '5072', '5073', '5074', '5075', '5076', '5077', '5078', '5080', '5082', '5083', '5084', '5085', '5102', '5103', '5106', '5107', '5108', '5200', '5201', '5203', '5210', '5212', '5213', '5214', '5215', '5216', '5217', '5222', '5223', '5224', '5225', '5226', '5232', '5233', '5234', '5235', '5236', '5237', '5242', '5243', '5244', '5245', '5246', '5247', '5252', '5272', '5300', '5301', '5303', '5304', '5305', '5306', '5312', '5313', '5314', '5315', '5316', '5317', '5318', '5322', '5323', '5324', '5325', '5326', '5330', '5332', '5333', '5334', '5335', '5400', '5403', '5404', '5405', '5406', '5408', '5412', '5413', '5415', '5416', '5417', '5420', '5423', '5425', '5426', '5430', '5432', '5436', '5437', '5442', '5443', '5444', '5445', '5452', '5453', '5462', '5463', '5464', '5466', '5467', '5468', '5502', '5503', '5504', '5505', '5506', '5507', '5512', '5522', '5524', '5525', '5600', '5603', '5604', '5605', '5606', '5607', '5608', '5610', '5612', '5613', '5614', '5615', '5616', '5617', '5618', '5619', '5620', '5621', '5622', '5623', '5624', '5625', '5626', '5627', '5628', '5630', '5632', '5634', '5636', '5637', '5638', '5639', '5642', '5643', '5644', '5645', '5646', '5647', '5648', '5649', '5702', '5703', '5704', '5705', '5706', '5707', '5708', '5722', '5723', '5724', '5725', '5726', '5727', '5728', '5732', '5733', '5734', '5735', '5736', '5737'],
  'St.Gallen': ['9000', '9001', '9002', '9003', '9004', '9006', '9007', '9008', '9010', '9011', '9012', '9014', '9015', '9016', '9050', '9052', '9053', '9054', '9055', '9056', '9057', '9062', '9063', '9064', '9070', '9071', '9072', '9073', '9074', '9080', '9081', '9082', '9083', '9084', '9100', '9103', '9104', '9105', '9107', '9108', '9112', '9113', '9114', '9115', '9116', '9122', '9123', '9125', '9126', '9200', '9202', '9203', '9204', '9205', '9212', '9213', '9214', '9215', '9216', '9217', '9220', '9223', '9224', '9225', '9226', '9230', '9231', '9233', '9234', '9240', '9242', '9243', '9244', '9245', '9246', '9247', '9248', '9250', '9260', '9261', '9300', '9301', '9302', '9303', '9304', '9305', '9306', '9307', '9308', '9312', '9313', '9314', '9315', '9316', '9320', '9322', '9323', '9325', '9326', '9327', '9400', '9401', '9402', '9403', '9404', '9405', '9410', '9413', '9414', '9415', '9422', '9423', '9424', '9425', '9426', '9427', '9428', '9430', '9434', '9435', '9436', '9437', '9442', '9443', '9444', '9445', '9450', '9451', '9452', '9453', '9454', '9455', '9456', '9462', '9463', '9464', '9465', '9466', '9467', '9468', '9469', '9470', '9471', '9472', '9473', '9474', '9475', '9476', '9477', '9478', '9479', '9482', '9484', '9485', '9486', '9487', '9492', '9493', '9494', '9500', '9502', '9503', '9504', '9506', '9507', '9508', '9512', '9514', '9515', '9517', '9523', '9524', '9525', '9532', '9533', '9534', '9535', '9536', '9542', '9543', '9545', '9546', '9547', '9548', '9552', '9553', '9554', '9555', '9562', '9565', '9566', '9573', '9583', '9592', '9593', '9594', '9602', '9604', '9606', '9607', '9608', '9609', '9612', '9613', '9614', '9615', '9620', '9621', '9622', '9630', '9633', '9634', '9635', '9642', '9643', '9644', '9646', '9647', '9648', '9652', '9656', '9657', '9658'],
  'Schwyz': ['6403', '6404', '6405', '6410', '6414', '6415', '6416', '6417', '6418', '6422', '6423', '6424', '6430', '6431', '6432', '6433', '6434', '6436', '6438', '6440', '6442', '6443', '6446', '6448', '6452', '6454', '6460', '6461', '6462', '6463', '6464', '6465', '6470', '6472', '6473', '6474', '6475', '6476', '6482', '6484', '6485', '8832', '8833', '8834', '8835', '8836', '8840', '8843', '8844', '8845', '8846', '8847', '8849', '8852', '8853', '8854', '8855', '8856', '8857', '8862', '8863', '8864', '8865', '8866', '8867', '8868', '8872', '8873', '8874', '8875', '8876', '8877', '8878', '8880', '8881', '8882', '8883', '8885', '8886', '8887', '8888', '8889', '8890', '8892', '8893', '8894', '8895', '8896', '8897'],
};

export default defineEventHandler(async (event) => {
  try {
    const authUser = await getAuthenticatedUser(event)
    if (!authUser || !(['admin', 'superadmin'].includes(authUser.role))) {
      throw createError({ statusCode: 403, message: 'Forbidden: Admin or Superadmin role required' })
    }

    const body = await readBody<PreloadRequest>(event)
    const { cantons } = body

    if (!cantons || cantons.length === 0) {
      throw createError({ statusCode: 400, message: 'Missing cantons in request body' })
    }

    logger.info(`üîÑ Starting PLZ distance preload for cantons: ${cantons.join(', ')}`)

    let totalPairsPreloaded = 0
    const selectedPostalCodes: string[] = []

    for (const canton of cantons) {
      if (allSwissPostalCodes[canton]) {
        selectedPostalCodes.push(...allSwissPostalCodes[canton])
      } else {
        logger.warn(`‚ö†Ô∏è Canton not found in postal code list: ${canton}`)
      }
    }

    if (selectedPostalCodes.length < 2) {
      throw createError({ statusCode: 400, message: 'Not enough postal codes to form pairs' })
    }

    const uniquePostalCodes = [...new Set(selectedPostalCodes)]
    logger.info(`üì¶ Preloading distances for ${uniquePostalCodes.length} unique postal codes.`)

    // Generate all unique pairs (from_plz, to_plz) including reverse
    const pairsToPreload = new Set<string>()
    for (let i = 0; i < uniquePostalCodes.length; i++) {
      for (let j = 0; j < uniquePostalCodes.length; j++) {
        const fromPlz = uniquePostalCodes[i]
        const toPlz = uniquePostalCodes[j]
        if (fromPlz === toPlz) continue // No travel time needed for same location

        // Add both directions
        pairsToPreload.add(`${fromPlz}‚Üí${toPlz}`)
      }
    }

    logger.info(`üìä Generated ${pairsToPreload.size} unique PLZ pairs for preloading.`)

    const calculator = availabilityCalculator // Use the singleton instance
    const now = new Date()

    // Process in batches to avoid overwhelming Google API
    const batchSize = 10 // Process 10 pairs at a time
    const pairsArray = Array.from(pairsToPreload)

    for (let i = 0; i < pairsArray.length; i += batchSize) {
      const batch = pairsArray.slice(i, i + batchSize)
      
      await Promise.all(
        batch.map(async (pairStr) => {
          const [fromPlz, toPlz] = pairStr.split('‚Üí')
          try {
            const travelTime = await calculator.getTravelTimeForSlot(fromPlz, toPlz, now)
            if (travelTime !== null) {
              totalPairsPreloaded++
            }
          } catch (err: any) {
            logger.warn(`‚ö†Ô∏è Error preloading travel time for ${fromPlz}‚Üí${toPlz}:`, err.message)
          }
        })
      )
      // Small delay between batches to respect API limits
      await new Promise(resolve => setTimeout(resolve, 200))
    }

    logger.info(`‚úÖ PLZ distance preload completed. Total pairs preloaded: ${totalPairsPreloaded}`)

    await logAudit({
      action: 'admin_preload_plz_distances',
      status: 'success',
      details: {
        cantons: cantons.join(', '),
        total_plz_count: uniquePostalCodes.length,
        total_pairs_generated: pairsToPreload.size,
        total_pairs_preloaded: totalPairsPreloaded
      }
    })

    return {
      success: true,
      message: `Successfully preloaded distances for ${totalPairsPreloaded} PLZ pairs.`,
      total_pairs_preloaded: totalPairsPreloaded
    }

  } catch (error: any) {
    logger.error('‚ùå PLZ distance preload failed:', error.message)

    await logAudit({
      action: 'admin_preload_plz_distances',
      status: 'error',
      error_message: error.message,
      details: {
        cantons: body?.cantons?.join(', ') || 'unknown',
        error_details: error.stack // Include stack for more info
      }
    })

    throw createError({
      statusCode: error.statusCode || 500,
      statusMessage: error.message || 'Failed to preload PLZ distances'
    })
  }
})
